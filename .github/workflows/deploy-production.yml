name: ðŸš€ Deploy to App Store (Production)

on:
  push:
    branches:
      - main

jobs:
  deploy-production:
    runs-on: macos-14
    timeout-minutes: 60
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.6'
      
      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
      
      - name: ðŸ“¦ Install CocoaPods Dependencies
        run: |
          if [ -f "Podfile" ]; then
            pod install --repo-update
          else
            echo "No Podfile found, skipping CocoaPods"
          fi
      
      - name: ðŸ” Import Code Signing Certificate
        env:
          CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          echo "$CERTIFICATE_BASE64" | base64 --decode > certificate.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import certificate.p12 \
            -k build.keychain \
            -P "$CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security
          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s -k "" build.keychain
          security list-keychains -d user -s build.keychain
          rm certificate.p12
      
      - name: ðŸ“ Import Provisioning Profile
        env:
          PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}  # Production profili
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROFILE_BASE64" | base64 --decode > \
            ~/Library/MobileDevice/Provisioning\ Profiles/production_profile.mobileprovision
      
      - name: ðŸ”¢ Increment Build Number
        run: |
          agvtool new-version -all ${{ github.run_number }}
      
      - name: ðŸ—ï¸ Build and Archive
        run: |
          xcodebuild archive \
            -project ExampleApp.xcodeproj \
            -scheme ExampleApp \
            -configuration Release \
            -archivePath $PWD/build/App-Production.xcarchive \
            -destination 'generic/platform=iOS' \
            -allowProvisioningUpdates \
            CODE_SIGN_STYLE=Manual \
            clean
        
        # âš ï¸ BURAYA DÄ°KKAT:
        # - YourApp â†’ Ana production scheme adÄ±nÄ±z
        # - Release â†’ Production configuration (AdÄ±m 1'de oluÅŸturduÄŸunuz)
      
      - name: ðŸ“¦ Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath $PWD/build/App-Production.xcarchive \
            -exportPath $PWD/build \
            -exportOptionsPlist ExportOptions-Production.plist
      
      - name: ðŸš€ Upload to App Store Connect
        env:
          API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
          ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        run: |
          mkdir -p ~/private_keys
          echo "$API_KEY" > ~/private_keys/AuthKey_$KEY_ID.p8
          
          xcrun altool --upload-app \
            --type ios \
            --file build/*.ipa \
            --apiKey $KEY_ID \
            --apiIssuer $ISSUER_ID
          
          echo "âœ… Production app successfully uploaded to App Store Connect!"
      
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          security delete-keychain build.keychain || true
          rm -rf build
          rm -rf ~/Library/MobileDevice/Provisioning\ Profiles/production_profile.mobileprovision
