name: ðŸ§ª Deploy to TestFlight (Staging)

on:
  push:
    branches:
      - develop

jobs:
  deploy-staging:
    runs-on: macos-14  # macOS 14 (Sonoma) - M1 chip
    timeout-minutes: 60
    
    steps:
      # 1. Kodu Ã§ek
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      # 2. Xcode versiyonunu ayarla
      - name: ðŸ”§ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.6'  # Projenizin gerektirdiÄŸi Xcode versiyonu
      
      # 3. Ruby kurulumu (Fastlane iÃ§in - opsiyonel)
      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
      
      # 4. Dependencies yÃ¼kle (CocoaPods varsa)
      - name: ðŸ“¦ Install CocoaPods Dependencies
        run: |
          if [ -f "Podfile" ]; then
            pod install --repo-update
          else
            echo "No Podfile found, skipping CocoaPods"
          fi
      
      # 5. SertifikayÄ± Keychain'e ekle
      - name: ðŸ” Import Code Signing Certificate
        env:
          CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Base64'ten geri Ã§evir
          echo "$CERTIFICATE_BASE64" | base64 --decode > certificate.p12
          
          # GeÃ§ici keychain oluÅŸtur
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          
          # SertifikayÄ± import et
          security import certificate.p12 \
            -k build.keychain \
            -P "$CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security
          
          # Keychain ayarlarÄ±
          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s -k "" build.keychain
          
          # Keychain'i listeye ekle
          security list-keychains -d user -s build.keychain
          
          # Temizlik
          rm certificate.p12
      
      # 6. Provisioning Profile'Ä± ekle
      - name: ðŸ“ Import Provisioning Profile
        env:
          PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE_TEST_BASE64 }}
        run: |
          # Provisioning Profile klasÃ¶rÃ¼nÃ¼ oluÅŸtur
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          
          # Profile'Ä± ekle
          echo "$PROFILE_BASE64" | base64 --decode > \
            ~/Library/MobileDevice/Provisioning\ Profiles/staging_profile.mobileprovision
      
      # 7. Build numarasÄ±nÄ± gÃ¼ncelle (opsiyonel ama Ã¶nerilen)
      - name: ðŸ”¢ Increment Build Number
        run: |
          # GitHub run number'Ä± build number olarak kullan
          agvtool new-version -all ${{ github.run_number }}
      
      # 8. Archive oluÅŸtur
      - name: ðŸ—ï¸ Build and Archive
        run: |
          xcodebuild archive \
            -project ExampleApp.xcodeproj \
            -scheme App-Staging \
            -configuration Staging \
            -archivePath $PWD/build/App-Staging.xcarchive \
            -destination 'generic/platform=iOS' \
            -allowProvisioningUpdates \
            CODE_SIGN_STYLE=Manual \
            clean
        
        # âš ï¸ BURAYA DÄ°KKAT:
        # - YourApp.xcworkspace â†’ Kendi workspace adÄ±nÄ±zÄ± yazÄ±n
        # - App-Staging â†’ Xcode'da oluÅŸturduÄŸunuz staging scheme adÄ±
        # - EÄŸer .xcworkspace yerine .xcodeproj kullanÄ±yorsanÄ±z:
        #   -project YourApp.xcodeproj yazÄ±n
      
      # 9. IPA dosyasÄ± oluÅŸtur
      - name: ðŸ“¦ Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath $PWD/build/App-Staging.xcarchive \
            -exportPath $PWD/build \
            -exportOptionsPlist ExportOptions-Staging.plist
      
      # 10. TestFlight'a yÃ¼kle
      - name: ðŸš€ Upload to TestFlight
        env:
          API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
          ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        run: |
          # API Key dosyasÄ±nÄ± oluÅŸtur
          mkdir -p ~/private_keys
          echo "$API_KEY" > ~/private_keys/AuthKey_$KEY_ID.p8
          
          # TestFlight'a yÃ¼kle
          xcrun altool --upload-app \
            --type ios \
            --file build/*.ipa \
            --apiKey $KEY_ID \
            --apiIssuer $ISSUER_ID
          
          echo "âœ… Test app successfully uploaded to TestFlight!"
      
      # 11. Temizlik (opsiyonel)
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          # Keychain'i sil
          security delete-keychain build.keychain || true
          
          # Build dosyalarÄ±nÄ± sil
          rm -rf build
          rm -rf ~/Library/MobileDevice/Provisioning\ Profiles/staging_profile.mobileprovision
